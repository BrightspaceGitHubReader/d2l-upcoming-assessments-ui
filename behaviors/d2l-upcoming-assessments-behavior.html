<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../d2l-fetch-siren-entity-behavior/d2l-fetch-siren-entity-behavior.html">
<link rel="import" href="../../d2l-hm-constants-behavior/d2l-hm-constants-behavior.html">
<link rel="import" href="./date-behavior.html">

<script src="https://s.brightspace.com/lib/siren-parser/6.0.0/siren-parser.js"></script>
<script>
	'use strict';

	window.D2L = window.D2L || {};
	window.D2L.UpcomingAssessments = window.D2L.UpcomingAssessments || {};

	/*
	* @polymerBehavior window.D2L.UpcomingAssessments.UpcomingAssessmentsBehavior
	*/
	var upcomingAssessmentsBehaviorImpl = {

		properties: {
			userUrl: String,
			getToken: {
				type: Object,
				value: function() {
					return null;
				}
			},
			_showError: {
				type: Boolean,
				value: false
			},
			_firstName: String,
			_allActivities: {
				type: Array,
				value: function() {
					return [];
				}
			},
			_previousPeriodUrl: String,
			_nextPeriodUrl: String,
			_periodStart: String,
			_periodEnd: String
		},

		_getCompletionState: function(userActivityUsage) {
			return {
				isCompleted: !!userActivityUsage.getSubEntityByClass(this.HypermediaClasses.activities.complete)
			};
		},

		_getDueDateState: function(userActivityUsage, overdueUserActivityUsages) {
			var activityIsOverdue = false;
			var activityIsDueToday = false;
			var dueDate;
			var dueDateEntity = userActivityUsage.getSubEntityByClass(this.HypermediaClasses.dates.dueDate);
			if (dueDateEntity) {
				dueDate = dueDateEntity.properties.date;
				activityIsDueToday = this.getDateDiffInCalendarDays(dueDate) === 0;
				activityIsOverdue = overdueUserActivityUsages.some(function(overdueUserUsage) {
					return overdueUserUsage.getLinkByRel('self').href === userActivityUsage.getLinkByRel('self').href;
				});
			}

			return {
				dueDate: dueDate,
				isOverdue: activityIsOverdue,
				isDueToday: activityIsDueToday
			};
		},

		_getEndDateState: function(userActivityUsage) {
			var activityIsEnded = false;
			var endDate;
			var endDateEntity = userActivityUsage.getSubEntityByClass(this.HypermediaClasses.dates.endDate);
			if (endDateEntity) {
				endDate = endDateEntity.properties.date;
				activityIsEnded = this.getDateDiffInCalendarDays(endDate) < 0;
			}

			return {
				endDate: endDate,
				isEnded: activityIsEnded
			};
		},

		_getActivityType: function(activity) {
			var type;
			if (activity.hasClass(this.HypermediaClasses.assignments.assignment)) {
				type = 'assignment';
			} else if (activity.hasClass(this.HypermediaClasses.quizzes.quiz)) {
				type = 'quiz';
			}
			return type;
		},

		_getOrganizationRequest: function(userActivityUsage, getToken, userUrl) {
			var organizationLink = (userActivityUsage.getLinkByRel(this.HypermediaRels.organization) || {} ).href;
			return this._fetchEntityWithToken(organizationLink, getToken, userUrl);
		},

		_getActivityRequest: function(userActivityUsage, getToken, userUrl) {
			var activityLink = (userActivityUsage.getLinkByRel(this.HypermediaRels.assignment)
					|| userActivityUsage.getLinkByRel(this.HypermediaRels.quiz) || {}).href;
			return Promise.resolve(this._fetchEntityWithToken(activityLink, getToken, userUrl))
				.catch(function(err) {
					var status = typeof err === 'number' ? err : err && err.status;
					if (typeof status === 'number' && status >= 400 && status < 500) {
						return null;
					}
					throw err;
				});
		},

		_getAssignmentInstructions: function(activity) {
			return this._getRichTextValuePreferPlainText(activity.getSubEntityByRel(this.HypermediaRels.Assignments.instructions));
		},

		_getQuizDescription: function(activity) {
			return this._getRichTextValuePreferPlainText(activity.getSubEntityByRel(this.HypermediaRels.Quizzes.description));
		},

		_getRichTextValuePreferPlainText: function(richtextEntity) {
			if (!richtextEntity || !richtextEntity.hasClass(this.HypermediaClasses.text.richtext) ||
				(!richtextEntity.properties.text && !richtextEntity.properties.html)) {
				return '';
			}

			return richtextEntity.properties.text || richtextEntity.properties.html;
		},

		/*
		* Returns an object that contains the information required to populate an assessment list item
		*/
		_getUserActivityUsagesInfos: function(userActivityUsages, overdueUserActivityUsages, getToken, userUrl) {
			if (!userActivityUsages.entities) {
				return;
			}

			var requests = [];
			var self = this;

			var overdueAssignments = overdueUserActivityUsages.getSubEntitiesByClass(self.HypermediaClasses.activities.userAssignmentActivity);
			var overdueQuizzes = overdueUserActivityUsages.getSubEntitiesByClass(self.HypermediaClasses.activities.userQuizActivity);
			var overdueUserUsages = [];
			overdueUserUsages = overdueUserUsages.concat(overdueAssignments);
			overdueUserUsages = overdueUserUsages.concat(overdueQuizzes);

			userActivityUsages.entities.forEach(function(userActivityUsage) {
				var organizationRequest = self._getOrganizationRequest.call(self, userActivityUsage, getToken, userUrl);
				var activityRequest = self._getActivityRequest.call(self, userActivityUsage, getToken, userUrl);

				var completionState = self._getCompletionState.call(self, userActivityUsage);
				var dueDateState = self._getDueDateState.call(self, userActivityUsage, overdueUserUsages);
				var endDateState = self._getEndDateState.call(self, userActivityUsage);

				var request = Promise.all([activityRequest, organizationRequest])
					.then(function(response) {
						var activity = response[0];
						var organization = response[1];

						if (!activity) {
							return null;
						}

						var type = self._getActivityType.call(self, activity);
						var info;
						if (type === 'quiz') {
							info = self._getQuizDescription.call(self, activity);
						} else if (type === 'assignment') {
							info = self._getAssignmentInstructions.call(self, activity);
						}

						return {
							name: activity.properties.name,
							courseName: organization.properties.name,
							info: info,
							dueDate: dueDateState.dueDate,
							endDate: endDateState.endDate,
							isCompleted: completionState.isCompleted,
							isDueToday: dueDateState.isDueToday,
							isOverdue: dueDateState.isOverdue,
							isEnded: endDateState.isEnded,
							type: type
						};
					});

				requests.push(request);
			});

			return Promise.all(requests)
				.then(function(responses) {
					var successResponses = responses.filter(function(response) {
						return !!response;
					});
					if (responses.length && !successResponses.length) {
						return Promise.reject(new Error('All activity requests failed'));
					}
					return successResponses;
				});
		},

		_getUserActivityUsages: function(userEntity, getToken, userUrl) {
			var myActivitiesLink = (userEntity.getLinkByRel(this.HypermediaRels.Activities.myActivities) || {}).href;
			var self = this;

			if (myActivitiesLink) {
				return this._getCustomRangeAction(myActivitiesLink, userUrl)
					.then(function(actitiviesLink) {
						return self._fetchEntityWithToken(actitiviesLink, getToken, userUrl);
					});
			}
		},

		_getOverdueActivities: function(activities, getToken, userUrl) {
			var overdueActivitiesLink = (activities.getLinkByRel(this.HypermediaRels.Activities.overdue) || {}).href;

			if (overdueActivitiesLink) {
				return this._fetchEntityWithToken(overdueActivitiesLink, getToken, userUrl);
			}

			// API doesn't include the overdue link if user doesn't have any overdue activities
			return window.D2L.Hypermedia.Siren.Parse({});
		},

		_getCustomRangeAction: function(activitiesUrl, userUrl) {
			if (!activitiesUrl) {
				return Promise.reject();
			}

			var self = this;

			return this._fetchEntityWithToken(activitiesUrl, this.getToken, userUrl)
				.then(function(activities) {
					var currentTime = new Date();
					var parameters = self._getCustomDateRangeParameters(currentTime);
					var action = (activities.getActionByName(self.HypermediaActions.activities.selectCustomDateRange) || {});

					self._selectCustomDateRangeAction = action;
					return self._createActionUrl(action, parameters);
				});
		},

		_getCustomDateRangeParameters: function(selectedDate) {
			var day = selectedDate.getDay();
			var startDate = new Date(selectedDate.setDate(selectedDate.getDate() - day));
			var start = startDate.toISOString();
			var twoWeeksFromStart = new Date(startDate.setDate(startDate.getDate() + 13));
			twoWeeksFromStart.setHours(23, 59, 59, 999);
			var end = twoWeeksFromStart.toISOString();

			return {
				start: start,
				end: end
			};
		},

		_getUser: function(userUrl, getToken) {
			return this._fetchEntityWithToken(userUrl, getToken);
		},

		_getInfo: function() {
			this._showError = false;
			var self = this;

			return this._fetchEntityWithToken(this.userUrl, this.getToken)
				.then(function(userEntity) {
					self._firstName = (userEntity.getSubEntityByRel(self.HypermediaRels.firstName) || { properties: {} }).properties.name;
					var myActivitiesLink = (userEntity.getLinkByRel(self.HypermediaRels.Activities.myActivities) || {}).href;
					return self._getCustomRangeAction(myActivitiesLink, self.userUrl)
						.then(function(customActivitiesLink) {
							return self._loadActivitiesForPeriod(customActivitiesLink);
						});
				})
				.catch(function() {
					self._showError = true;
					self._firstName = null;
				});
		},

		_loadActivitiesForPeriod: function(periodUrl) {
			if (!periodUrl) {
				return Promise.reject();
			}

			var self = this;
			var userActivityUsages;

			return this._fetchEntityWithToken(periodUrl, this.getToken, this.userUrl)
				.then(function(userUsages) {
					userActivityUsages = userUsages;
					self._previousPeriodUrl = (userActivityUsages.getLinkByRel(self.HypermediaRels.Activities.previousPeriod) || {}).href;
					self._nextPeriodUrl = (userActivityUsages.getLinkByRel(self.HypermediaRels.Activities.nextPeriod) || {}).href;
					self._periodStart = userActivityUsages.properties.start;
					self._periodEnd = userActivityUsages.properties.end;

					return self._getOverdueActivities(userActivityUsages, self.getToken, self.userUrl);
				})
				.then(function(overdueUserActivityUsages) {
					return self._getUserActivityUsagesInfos(userActivityUsages, overdueUserActivityUsages, self.getToken, self.userUrl);
				})
				.then(function(userActivityUsagesInfos) {
					return self._updateActivitiesInfo(userActivityUsagesInfos, self.getToken, self.userUrl);
				})
				.then(function(activities) {
					self.set('_allActivities', activities);
					return activities;
				});
		},

		_updateActivitiesInfo: function(activities) {
			activities = activities || [];
			return activities
				.filter(function(activity) {
					return activity.dueDate || activity.endDate;
				})
				.sort(function(a, b) {
					return (a.dueDate || a.endDate) > (b.dueDate || b.endDate);
				});
		},

		_createActionUrl: function(action, parameters) {
			var query = {};
			if (action.fields) {
				action.fields.forEach(function(field) {
					if (parameters.hasOwnProperty(field.name)) {
						query[field.name] = parameters[field.name];
					} else {
						query[field.name] = field.value;
					}
				});
			}

			var queryString = Object.keys(query).map(function(key) {
				return key + '=' + query[key];
			}).join('&');

			return queryString ? action.href + '?' + queryString : action.href;
		}
	};

	window.D2L.UpcomingAssessments.UpcomingAssessmentsBehavior = [
		window.D2L.UpcomingAssessments.DateBehavior,
		window.D2L.FetchSirenEntityBehavior,
		window.D2L.Hypermedia.HMConstantsBehavior,
		upcomingAssessmentsBehaviorImpl
	];

</script>
